<!doctype html><html lang=pt-br>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="pt-br">
<meta name=color-scheme content="light dark">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self'; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; prefetch-src 'self'; connect-src 'self';">
<meta name=author content="Eduardo Weiland">
<meta name=description content="Como eu já havia comentado no último post sobre o Placarduino, o projeto já estava precisando de uma refatoração (quase) completa. E eu realmente fiz isso. Então, neste post eu pretendo descrever resumidamente as principais mudanças que eu fiz (o post sobre o RFID terá que esperar, já que essa parte também precisa de uma refatoração).
Que rufem os tambores    Ou melhor, o buzzer. E foi por essa parte que eu comecei a refatoração.">
<meta name=keywords content="blog,home,portfolio,personal,developer,maker">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Refatoração do Placarduino">
<meta name=twitter:description content="Como eu já havia comentado no último post sobre o Placarduino, o projeto já estava precisando de uma refatoração (quase) completa. E eu realmente fiz isso. Então, neste post eu pretendo descrever resumidamente as principais mudanças que eu fiz (o post sobre o RFID terá que esperar, já que essa parte também precisa de uma refatoração).
Que rufem os tambores    Ou melhor, o buzzer. E foi por essa parte que eu comecei a refatoração.">
<meta property="og:title" content="Refatoração do Placarduino">
<meta property="og:description" content="Como eu já havia comentado no último post sobre o Placarduino, o projeto já estava precisando de uma refatoração (quase) completa. E eu realmente fiz isso. Então, neste post eu pretendo descrever resumidamente as principais mudanças que eu fiz (o post sobre o RFID terá que esperar, já que essa parte também precisa de uma refatoração).
Que rufem os tambores    Ou melhor, o buzzer. E foi por essa parte que eu comecei a refatoração.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ew.dev.br/posts/2018/01/refatoracao-do-placarduino/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-01-14T11:27:54-02:00">
<meta property="article:modified_time" content="2018-01-14T11:27:54-02:00">
<meta property="og:see_also" content="https://ew.dev.br/posts/2018/02/reset-automatico-do-placarduino-apos-o-fim-do-jogo/"><meta property="og:see_also" content="https://ew.dev.br/posts/2018/02/fim-de-jogo-para-o-placarduino/"><meta property="og:see_also" content="https://ew.dev.br/posts/2018/01/cartoes-de-acesso-para-o-placarduino/"><meta property="og:see_also" content="https://ew.dev.br/posts/2018/01/atualizacao-do-placarduino-reducao-de-pontos/"><meta property="og:see_also" content="https://ew.dev.br/posts/2017/11/display-maior-numeros-maiores/">
<title>
Refatoração do Placarduino · Eduardo Weiland
</title>
<link rel=canonical href=https://ew.dev.br/posts/2018/01/refatoracao-do-placarduino/>
<link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=/css/coder.min.cbf6f68b2a836dd1d34f005153262dd21d148461cf33684940f1bb4c048821b1.css integrity="sha256-y/b2iyqDbdHTTwBRUyYt0h0UhGHPM2hJQPG7TASIIbE=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=/css/coder-dark.min.dde8a61eb31a32353b4baf3d9113f03c4ea2a8ca9bb736f59ca2d2b2cb664f0b.css integrity="sha256-3eimHrMaMjU7S689kRPwPE6iqMqbtzb1nKLSsstmTws=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=/css/custom.css>
<link rel=icon type=image/png href=/images/favicon32.png sizes=32x32>
<link rel=icon type=image/png href=/images/favicon16.png sizes=16x16>
<link rel=apple-touch-icon href=/images/apple-touch-icon.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<meta name=generator content="Hugo 0.88.1">
</head>
<body class="preload-transitions colorscheme-auto">
<div class=float-container>
<a id=dark-mode-toggle class=colorscheme-toggle>
<i class="fa fa-adjust fa-fw" aria-hidden=true></i>
</a>
</div>
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=/>
Eduardo Weiland
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/posts/>Blog</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://ew.dev.br/posts/2018/01/refatoracao-do-placarduino/>
Refatoração do Placarduino
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2018-01-14T11:27:54-02:00>
Jan 14, 2018
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
3 minutos de leitura
</span>
</div>
<div class=tags>
<i class="fa fa-tag" aria-hidden=true></i>
<a href=/tags/arduino/>arduino</a>
<span class=separator>•</span>
<a href=/tags/eletronica/>eletronica</a>
<span class=separator>•</span>
<a href=/tags/placarduino/>placarduino</a></div>
</div>
</header>
<div>
<p>Como eu já havia comentado no <a href=/posts/2018/01/atualizacao-do-placarduino-reducao-de-pontos/>último post sobre o Placarduino</a>, o projeto já
estava precisando de uma refatoração (quase) completa. E eu realmente fiz isso.
Então, neste post eu pretendo descrever resumidamente as principais mudanças que
eu fiz (o post sobre o RFID terá que esperar, já que essa parte também precisa de
uma refatoração).</p>
<h2 id=que-rufem-os-tambores>
Que rufem os tambores
<a class=heading-link href=#que-rufem-os-tambores>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>Ou melhor, o buzzer. E foi por essa parte que eu comecei a refatoração. Eu havia
criado 3 &ldquo;músicas de abertura&rdquo; para o Placarduino, mas para trocar entre as músicas
era necessário comentar uma parte do código e descomentar outra! E, além disso,
criar uma nova melodia era bastante trabalhoso e repetitivo.</p>
<p>Para resolver tudo isso, eu criei uma biblioteca MusicPlayer que &ldquo;implementa&rdquo;
essas músicas como métodos. Por exemplo, se eu quiser tocar o tema do Super Mário
na abertura do Placarduino, eu só preciso chamar <code>musicPlayer.superMarioTheme()</code>.
E para trocar a música, basta trocar o nome do método.</p>
<p>Além disso, a classe possui dois métodos auxiliares: <code>playNote</code> e <code>pause</code>. Com
isso, criar as músicas ficou mais simples e fácil de entender:</p>
<p><img src=/images/refatoracao-musicplayer-super-mario.png alt="Código para o Tema do Super Mário antes e depois da refatoração"></p>
<p>Para o futuro, já estou pensando em melhorar um pouco mais essa biblioteca, para
deixá-la mais &ldquo;artística&rdquo;. Algumas das ideias são: configurar o <a href=https://pt.wikipedia.org/wiki/Andamento>andamento</a> da
música e usar <a href=https://pt.wikipedia.org/wiki/Dura%C3%A7%C3%A3o_(m%C3%BAsica)>duração</a> de notas em vez de milissegundos. Contudo, algumas
construções mais complexas não se encaixariam nessa regra (ex.: <a href=https://pt.wikipedia.org/wiki/Qui%C3%A1ltera>quiálteras</a>),
então ainda preciso estudar um pouco mais como fazer isso.</p>
<p><strong>Mais detalhes:</strong> <a href=https://github.com/eduardoweiland/placarduino/commit/8cc6dd42ed49d8c6b172840ae588b72766309236>Refatoração completa do MusicPlayer</a></p>
<h2 id=controle-dos-jogadores>
Controle dos jogadores
<a class=heading-link href=#controle-dos-jogadores>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>A segunda parte da refatoração foi relacionada aos dados dos jogadores que
estavam em variáveis espalhadas pelo arquivo principal (nome dos jogadores,
pontuação, estado dos botões). Cada vez que era necessário adicionar uma
informação nova para um jogador novo, era trabalho duplicado. E ainda por cima
a leitura dos botões estava muito confusa.</p>
<p>Assim, surgiram duas novas classes: <code>RisingEdgeButton</code> <em>(como biblioteca)</em> e
<code>PlayerControl</code> <em>(no projeto mesmo)</em>.</p>
<p>Começando pelo botão, eu até pesquisei outras bibliotecas prontas para facilitar
uso de botões, mas a maioria era complexa demais e/ou pouco flexível. As melhores
que eu encontrei só funcionavam se o botão fosse configurado como <code>INPUT_PULLUP</code>
no Arduino, o que eu não estou utilizando e nem pretendo utilizar.</p>
<p>Então, eu mesmo criei uma biblioteca bem simples e nada flexível, utilizando a
mesma lógica que eu já utilizava, mas movendo a leitura do botão e a variável de
estado dele para dentro de uma classe.</p>
<p><strong>Mais detalhes:</strong> <a href=https://github.com/eduardoweiland/placarduino/commit/1c424fc206babfc5e2fb2fcf794144af379810cc>Criação do RisingEdgeButton</a></p>
<p>A nova classe <code>PlayerControl</code> é, agora, a responsável por fazer a leitura dos
botões (usando o <code>RisingEdgeButton</code>) e alterar o placar de acordo com o que foi
pressionado.</p>
<p>No arquivo principal do projeto, a função <code>checkButtons()</code> ainda existe, mas ela
apenas chama os métodos <code>updateScore()</code> dos dois jogadores (esse é o método que
lê o input do botão e atualiza o placar, se necessário). De acordo com o retorno
da chamada dos métodos (-1 se o placar foi reduzido e +1 se foi aumentado), o
arquivo principal ainda é o responsável por tocar o som de <em>feedback</em> e atualizar
o placar no display.</p>
<p>A legibilidade do código ficou muito melhor com essa alteração:</p>
<p><img src=/images/refatoracao-check-buttons.png alt="Função checkButtons antes e depois da refatoração"></p>
<p><strong>Mais detalhes:</strong> <a href=https://github.com/eduardoweiland/placarduino/commit/65a17c702fc61e1eac20e00efa50540a301fca26>Criação do PlayerControl</a></p>
<h2 id=refactormap---_roadmap_-de-refatoração>
&ldquo;Refactormap&rdquo; - <em>roadmap</em> de refatoração
<a class=heading-link href=#refactormap---_roadmap_-de-refatora%c3%a7%c3%a3o>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>Como eu já comentei no começo deste post, o uso do RFID precisa de uma refatoração
antes de ser publicado (como está agora, tudo é feito em uma única função de 60
linhas, literalmente).</p>
<p>Outra refatoração que eu já estou pensando é de mover toda a lógica do Placarduino
para uma classe separada. Com isso, o arquivo principal deve virar basicamente
um arquivo de configuração.</p>
<p><del>A refatoração está sendo feita em um branch separado, você pode conferir o
progresso no GitHub</del> branch já foi integrado - ver o <a href=https://github.com/eduardoweiland/placarduino/pull/1>pull request</a>.</p>
</div>
<footer>
<section class=see-also>
<h3 id=see-also-in-placarduino>
See also in placarduino
<a class=heading-link href=#see-also-in-placarduino>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<nav>
<ul>
<li>
<a href=/posts/2018/02/reset-automatico-do-placarduino-apos-o-fim-do-jogo/>Reset automático do Placarduino após o fim do jogo</a>
</li>
<li>
<a href=/posts/2018/02/fim-de-jogo-para-o-placarduino/>Fim de jogo para o Placarduino</a>
</li>
<li>
<a href=/posts/2018/01/cartoes-de-acesso-para-o-placarduino/>Cartões de acesso para o Placarduino</a>
</li>
<li>
<a href=/posts/2018/01/atualizacao-do-placarduino-reducao-de-pontos/>Atualização do Placarduino: redução de pontos</a>
</li>
<li>
<a href=/posts/2017/11/display-maior-numeros-maiores/>Display maior, números maiores</a>
</li>
</ul>
</nav>
</section>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
&copy;
2011 -
2021
Eduardo Weiland
&#183;
<a rel="license noopener" href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a>
&#183;
<a rel=noopener href=https://github.com/eduardoweiland/ew.dev.br>Free Software</a>
</section>
</footer>
</main>
<script src=/js/coder.min.235666b114443867d43eeb5799d51f6252965e5163f338285e113fa381d3d27e.js integrity="sha256-I1ZmsRREOGfUPutXmdUfYlKWXlFj8zgoXhE/o4HT0n4="></script>
</body>
</html>