<!doctype html><html lang=pt-br><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="pt-br"><meta name=color-scheme content="light dark"><meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self'; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; prefetch-src 'self'; connect-src 'self';"><meta name=author content="Eduardo Weiland"><meta name=description content="O Ansible é uma ferramenta muito útil para várias tarefas, devido, principalmente, à sua flexibilidade. A grande quantidade de módulos existentes torna fácil automatizar qualquer tipo de processo, mesmo quando o Ansible não seja a opção mais óbvia.
Por exemplo, quando você precisa compilar um pacote que necessita de etapas adicionais de configuração: isso pode ser automatizado pelo Ansible.
Vou mostrar aqui um exemplo de como eu criei um playbook para compilar uma biblioteca de autenticação para o Mosquitto, o mosquitto-auth-plug."><meta name=keywords content="blog,home,portfolio,personal,developer,maker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Usando o Ansible para compilar uma biblioteca"><meta name=twitter:description content="O Ansible é uma ferramenta muito útil para várias tarefas, devido, principalmente, à sua flexibilidade. A grande quantidade de módulos existentes torna fácil automatizar qualquer tipo de processo, mesmo quando o Ansible não seja a opção mais óbvia.
Por exemplo, quando você precisa compilar um pacote que necessita de etapas adicionais de configuração: isso pode ser automatizado pelo Ansible.
Vou mostrar aqui um exemplo de como eu criei um playbook para compilar uma biblioteca de autenticação para o Mosquitto, o mosquitto-auth-plug."><meta property="og:title" content="Usando o Ansible para compilar uma biblioteca"><meta property="og:description" content="O Ansible é uma ferramenta muito útil para várias tarefas, devido, principalmente, à sua flexibilidade. A grande quantidade de módulos existentes torna fácil automatizar qualquer tipo de processo, mesmo quando o Ansible não seja a opção mais óbvia.
Por exemplo, quando você precisa compilar um pacote que necessita de etapas adicionais de configuração: isso pode ser automatizado pelo Ansible.
Vou mostrar aqui um exemplo de como eu criei um playbook para compilar uma biblioteca de autenticação para o Mosquitto, o mosquitto-auth-plug."><meta property="og:type" content="article"><meta property="og:url" content="https://ew.dev.br/posts/2017/09/usando-o-ansible-para-compilar-uma-biblioteca/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-09-11T22:08:35-03:00"><meta property="article:modified_time" content="2017-09-11T22:08:35-03:00"><title>Usando o Ansible para compilar uma biblioteca · Eduardo Weiland</title><link rel=canonical href=https://ew.dev.br/posts/2017/09/usando-o-ansible-para-compilar-uma-biblioteca/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.cbf6f68b2a836dd1d34f005153262dd21d148461cf33684940f1bb4c048821b1.css integrity="sha256-y/b2iyqDbdHTTwBRUyYt0h0UhGHPM2hJQPG7TASIIbE=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.dde8a61eb31a32353b4baf3d9113f03c4ea2a8ca9bb736f59ca2d2b2cb664f0b.css integrity="sha256-3eimHrMaMjU7S689kRPwPE6iqMqbtzb1nKLSsstmTws=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.css><link rel=icon type=image/png href=/images/favicon32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.119.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Eduardo Weiland</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://ew.dev.br/posts/2017/09/usando-o-ansible-para-compilar-uma-biblioteca/>Usando o Ansible para compilar uma biblioteca</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2017-09-11T22:08:35-03:00>Sep 11, 2017</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
3 minutos de leitura</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<a href=/tags/ansible/>ansible</a></div></div></header><div><img src=/images/ansible-logo.png alt="Featured image"><p>O Ansible é uma ferramenta muito útil para várias tarefas, devido, principalmente,
à sua flexibilidade. A grande quantidade de módulos existentes torna fácil
automatizar qualquer tipo de processo, mesmo quando o Ansible não seja a opção
mais óbvia.</p><p>Por exemplo, quando você precisa compilar um pacote que necessita de etapas
adicionais de configuração: isso pode ser automatizado pelo Ansible.</p><p>Vou mostrar aqui um exemplo de como eu criei um playbook para compilar uma
biblioteca de autenticação para o Mosquitto, o <a href=https://github.com/jpmens/mosquitto-auth-plug>mosquitto-auth-plug</a>.</p><hr><p>Para começar, a compilação precisa de algumas dependências. Vamos criar uma
role no Ansible para instalar as dependências desse pacote (aqui eu utilizei
apenas o DNF para instalar os pacotes no Fedora).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#6272a4># roles/install-dependencies/tasks/main.yml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: Install build dependencies
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>become</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>dnf</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>state</span>: latest
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>with_items</span>:
</span></span><span style=display:flex><span>    - mosquitto-devel
</span></span><span style=display:flex><span>    - openssl-devel
</span></span><span style=display:flex><span>    - curl-devel
</span></span><span style=display:flex><span>    - git
</span></span><span style=display:flex><span>    - <span style=color:#f1fa8c>&#34;@development-tools&#34;</span>
</span></span></code></pre></div><p>Agora vamos criar o playbook e adicionar essa role para testar.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#6272a4># build.xml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>hosts</span>: local
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>roles</span>:
</span></span><span style=display:flex><span>    - install-dependencies
</span></span></code></pre></div><p>A execução é feita com o comando <code>ansible-playbook</code>, utilizando a flag <code>-K</code> para
pedir a senha de <code>sudo</code>, que é necessária para instalar os pacotes com o DNF. O
inventário utilizado aqui possui apenas o <code>localhost</code> configurado:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ ansible-playbook -K -i inventory build.yml
</span></span></code></pre></div><p>Se tudo der certo, agora você já possui todas as dependências necessárias
instaladas. Hora de configurar a compilação, que envolve três etapas:</p><ol><li>Baixar o código-fonte do repositório git</li><li>Adicionar o arquivo de configuração da compilação (config.mk)</li><li>Rodar o make para compilar a biblioteca</li></ol><p>Colocando tudo isso em uma segunda role separada:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#6272a4># roles/build/tasks/main.yml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: Clone source code repository
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>git</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>repo</span>: https://github.com/jpmens/mosquitto-auth-plug.git
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>dest</span>: /tmp/mosquitto-auth-plug
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: Render build options
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>src</span>: config.mk.j2
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>dest</span>: /tmp/mosquitto-auth-plug/config.mk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: Build library
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>make</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>chdir</span>: /tmp/mosquitto-auth-plug
</span></span></code></pre></div><p>O arquivo de configuração é renderizado pelo módulo template do Ansible, então
é possível utilizar variáveis, condicionais, laços, e outras estruturas para
&ldquo;montar&rdquo; esse arquivo dinamicamente. Eu não precisei utilizar nada disso, então
o template é apenas copiado como está para o caminho especificado. A
configuração que eu utilizei foi essa:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># roles/build/templates/config.mk.j2
</span></span><span style=display:flex><span># Select your backends from this list
</span></span><span style=display:flex><span>BACKEND_CDB ?= no
</span></span><span style=display:flex><span>BACKEND_MYSQL ?= no
</span></span><span style=display:flex><span>BACKEND_SQLITE ?= no
</span></span><span style=display:flex><span>BACKEND_REDIS ?= no
</span></span><span style=display:flex><span>BACKEND_POSTGRES ?= no
</span></span><span style=display:flex><span>BACKEND_LDAP ?= no
</span></span><span style=display:flex><span>BACKEND_HTTP ?= yes
</span></span><span style=display:flex><span>BACKEND_JWT ?= no
</span></span><span style=display:flex><span>BACKEND_MONGO ?= no
</span></span><span style=display:flex><span>BACKEND_FILES ?= no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Specify the path to the Mosquitto sources here
</span></span><span style=display:flex><span>MOSQUITTO_SRC = /usr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Specify the path the OpenSSL here
</span></span><span style=display:flex><span>OPENSSLDIR = /usr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Specify optional/additional linker/compiler flags here
</span></span><span style=display:flex><span>CFG_LDFLAGS =
</span></span><span style=display:flex><span>CFG_CFLAGS =
</span></span></code></pre></div><p>Depois de adicionar essa role no playbook <code>build.yml</code>, o comando <code>ansible-playbook</code>
pode ser executado novamente com os mesmos parâmetros. Pronto, agora a biblioteca
deve estar compilada em <code>/tmp/mosquitto-auth-plug/auth-plug.so</code> 😀.</p><p>Esse foi um exemplo bem básico de como o Ansible pode ser utilizado para compilar
um pacote utilizando os módulos git, template e make. Muita coisa ainda pode ser
melhorada, mas pelo menos não será mais necessário realizar todas essas etapas
manualmente 🙂.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>&copy;
2011 -
2023
Eduardo Weiland
&#183;
<a rel="license noopener" href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a>
&#183;
<a rel=noopener href=https://github.com/eduardoweiland/ew.dev.br>Free Software</a></section></footer></main><script src=/js/coder.min.978ac2219b08e24e68c3f3eada8d99add50d9d997ce3861354b602cc94f75f30.js integrity="sha256-l4rCIZsI4k5ow/Pq2o2ZrdUNnZl844YTVLYCzJT3XzA="></script></body></html>